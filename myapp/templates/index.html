<!DOCTYPE html>
{% load static %}
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat App</title>
    <link rel="shortcut icon" type="image/jpg" href="{% static 'img/favicon.ico' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static "cs/chat.css" %}"/>
  </head>
  <body>
    <a href="{% url 'log-out' %}">Log Out</a>
    <div class="intro">
    <h1>{{g_name}}</h1>
    <h1>{{request.user}}</h1>
</div>
     <div id="chat-log" contenteditable>
    
        {% for chat in chats %}
        <div class="msg">
            <div class="msg-head">
                <b>{{chat.sender}}</b>
            <small>{{chat.timestamp|time:'H:i'}}</small>
            </div>
            {{chat.content}}
            </div>
        {% endfor %}
        
    </div> 
    <div class="sendbar">
    <input type="text" id="chat-msg-input" />
    <input type="submit" value="Send" id="chat-msg-submit" />
</div>

    {{g_name|json_script:'group-name'}}

    <script>
      const groupName = JSON.parse(
        document.getElementById("group-name").textContent
      );
      var ws = new WebSocket("ws://127.0.0.1:8000/ws/jwc/" + groupName + "/");
      // var ws = new WebSocket('ws://127.0.0.1:8000/ws/ajwc/'+ groupName + '/')

      ws.onopen = function () {
        console.log("WebSocket connection open...", event);
        var myDiv = document.getElementById("chat-log");
        myDiv.scrollTop = myDiv.scrollHeight;
        // ws.send('hii from client')
      };
      ws.onmessage = function () {
        console.log("new msg from server...", event.data);
        console.log("new msg from server...", event);
        const data = JSON.parse(event.data);
        // document.querySelector("#chat-log").value += (data.message + "\n");
        document.querySelector("#chat-log").innerHTML += "<div class='msg'> <div class='msg-head'><b>" + data.message.user + "</b> </div>"+ data.message.msg + "</div>";
        var myDiv = document.getElementById("chat-log");
        myDiv.scrollTop = myDiv.scrollHeight;
      };
      ws.onclose = function () {
        console.log("disconnected...", event);
      };

      document.getElementById("chat-msg-submit").onclick = function (event) {
        const messageInputDom = document.getElementById("chat-msg-input");
        const message = messageInputDom.value;
        ws.send(
          JSON.stringify({
            msg: message,
          })
        );
        messageInputDom.value = "";
      };
    </script>
  </body>
</html>
